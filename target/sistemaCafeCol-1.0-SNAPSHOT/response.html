<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Pago - Resultado</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-dark text-light">
  <div class="container py-5">
    <div id="resultado" class="text-center">
      <div class="spinner-border" role="status"></div>
      <p class="mt-3">Procesando resultado del pago...</p>
    </div>
  </div>

  <script>
    (async function () {
      // Aquí ePayco redirige con query params. Mostramos un mensaje y limpiamos carrito local.
      const params = new URLSearchParams(window.location.search);
      const tx = params.get('x_transaction_id') || params.get('transactionId') || null;
      const state = params.get('x_transaction_state') || params.get('transactionState') || null;

      const cont = document.getElementById('resultado');

      if (state && state.toLowerCase().includes('acept')) {
        cont.innerHTML = '<h3 class="text-success">Pago aprobado ✅</h3><p>Gracias por tu compra. En breve recibirás la confirmación.</p>';
      } else if (state) {
        cont.innerHTML = '<h3 class="text-warning">Pago pendiente / rechazado</h3><p>Si crees que hubo un error, por favor intenta de nuevo.</p>';
      } else {
        cont.innerHTML = '<h3 class="text-info">Pago procesado</h3><p>Verifica tu correo o la sección de pedidos para más detalles.</p>';
      }

      // Intentar vaciar carrito visual y limpiar cliente local (si el backend ya creó el pedido lo ideal es que el confirmation lo vacíe)
      try {
        await fetch(`${window.API_BASE_URL}/carrito/vaciar`, { method: 'DELETE' });
      } catch (e) {
        console.warn('No se pudo vaciar carrito en backend:', e);
      }
      try { localStorage.removeItem('clienteId'); } catch (e) {}
    })();
  </script>
</body>
</html>
